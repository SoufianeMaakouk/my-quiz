<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FISU Quiz Game</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(to right, #4facfe, #00f2fe);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 10px;
    }

    #quiz-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 30px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      background-color: #4facfe;
      color: white;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
      transition: background-color 0.3s, transform 0.2s;
    }

    button:hover {
      background-color: #3a9de1;
      transform: translateY(-3px);
    }

    button:active {
      transform: translateY(1px);
    }

    input[type="text"] {
      padding: 10px;
      width: 80%;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 10px;
      font-size: 16px;
    }

    #timer {
      font-size: 18px;
      color: #e74c3c;
      margin-top: 15px;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    #result, #score {
      font-size: 16px;
      margin-top: 10px;
    }

    #leaderboard {
      margin-top: 20px;
      text-align: left;
    }

    #leaderboard table {
      width: 100%;
      border-collapse: collapse;
    }

    #leaderboard th, #leaderboard td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    #leaderboard th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>

<div id="quiz-container">
  <h2>üèÖ FISU Quiz Game (RR2025 Edition)</h2>
  <button id="startBtn" onclick="startGame()">Start Game</button>

  <div id="quizContent" style="display:none;">
    <div id="question">Loading question...</div>
    <input type="text" id="answer" placeholder="Type your answer here">
    <br>
    <button onclick="checkAnswer()">Submit</button>
    <button onclick="skipQuestion()">Skip</button>
    <button id="playAgainBtn" onclick="restartGame()" style="display: none;">üîÅ Play Again</button>
    <div id="timer"></div>
    <div id="result"></div>
    <div id="score"></div>

    <div id="leaderboard">
      <h3>üèÜ Leaderboard</h3>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody id="leaderboardList"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const backendURL = 'https://quiz-backend-8ug1.onrender.com';

  let quizData = [];
  let currentQuestion = 0;
  let score = 0;
  let timeLeft = 20;
  let timerInterval;
  let playerName = '';
  const totalQuestions = 20;

  const synonymMap = {
    "usa": "united states",
    "u.s.a.": "united states",
    "united states of america": "united states",
    "uk": "united kingdom",
    "england": "united kingdom",
    "olympics": "olympic games",
    "fifa": "world cup",
    "soccer": "football"
  };

  const normalize = text =>
    synonymMap[text.trim().toLowerCase().replace(/[^\w\s]/gi, '').replace(/\s+/g, ' ')] || 
    text.trim().toLowerCase().replace(/[^\w\s]/gi, '').replace(/\s+/g, ' ');

  const levenshtein = (a, b) => {
    const dp = Array.from({ length: a.length + 1 }, () => Array(b.length + 1).fill(0));
    for (let i = 0; i <= a.length; i++) dp[i][0] = i;
    for (let j = 0; j <= b.length; j++) dp[0][j] = j;
    for (let i = 1; i <= a.length; i++) {
      for (let j = 1; j <= b.length; j++) {
        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
        dp[i][j] = Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1, dp[i - 1][j - 1] + cost);
      }
    }
    return dp[a.length][b.length];
  };

  const shuffle = array => {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  };

  async function loadQuestions() {
    const res = await fetch(`${backendURL}/questions`);
    const data = await res.json();
    quizData = shuffle(data).slice(0, totalQuestions);
    loadQuestion();
  }

  function startGame() {
    playerName = prompt("Enter your name:");
    if (!playerName) return alert("Name is required.");
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('quizContent').style.display = 'block';
    score = 0;
    currentQuestion = 0;
    document.getElementById('score').textContent = '';
    document.getElementById('result').textContent = '';
    loadQuestions();
  }

  function loadQuestion() {
    if (currentQuestion < quizData.length) {
      document.getElementById('question').textContent = quizData[currentQuestion].question;
      const input = document.getElementById('answer');
      input.value = '';
      input.disabled = false;
      input.focus();
      timeLeft = 20;
      updateTimer();
      startTimer();
    } else {
      endQuiz();
    }
  }

  function startTimer() {
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      timeLeft--;
      updateTimer();
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        document.getElementById('result').textContent = `‚è∞ Time's up! Answer: ${quizData[currentQuestion].answer}`;
        document.getElementById('answer').disabled = true;
        currentQuestion++;
        setTimeout(loadQuestion, 2000);
      }
    }, 1000);
  }

  function updateTimer() {
    document.getElementById('timer').textContent = `‚è±Ô∏è Time left: ${timeLeft}s`;
  }

  function checkAnswer() {
    clearInterval(timerInterval);
    const userAnswer = normalize(document.getElementById('answer').value);
    const correctAnswer = normalize(quizData[currentQuestion].answer);
    const distance = levenshtein(userAnswer, correctAnswer);
    const allowedDistance = Math.floor(correctAnswer.length * 0.25);

    if (userAnswer === correctAnswer || distance <= allowedDistance) {
      document.getElementById('result').textContent = userAnswer === correctAnswer
        ? "‚úÖ Correct!" : "ü§è Close enough! Accepted.";
      score++;
    } else {
      document.getElementById('result').textContent = `‚ùå Wrong. Answer: ${quizData[currentQuestion].answer}`;
    }

    document.getElementById('score').textContent = `Score: ${score}`;
    document.getElementById('answer').disabled = true;
    currentQuestion++;
    setTimeout(loadQuestion, 2000);
  }

  function skipQuestion() {
    clearInterval(timerInterval);
    document.getElementById('result').textContent = `‚è≠Ô∏è Skipped. Answer: ${quizData[currentQuestion].answer}`;
    currentQuestion++;
    setTimeout(loadQuestion, 2000);
  }

  function endQuiz() {
    document.getElementById('question').textContent = "üéâ Quiz Completed!";
    document.getElementById('answer').style.display = "none";
    document.querySelectorAll('button').forEach(btn => btn.style.display = "none");
    document.getElementById('playAgainBtn').style.display = "inline-block";
    document.getElementById('timer').style.display = "none";
    document.getElementById('score').textContent = `Final Score: ${score}`;
    updateLeaderboard();
  }

  async function updateLeaderboard() {
    try {
      await fetch(`${backendURL}/submit-score`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: playerName, score })
      });
      const res = await fetch(`${backendURL}/leaderboard`);
      const data = await res.json();
      renderLeaderboard(data);
    } catch (err) {
      console.error('‚ùå Failed to update leaderboard:', err);
    }
  }

  function renderLeaderboard(data = []) {
    const tbody = document.getElementById('leaderboardList');
    tbody.innerHTML = '';
    data.forEach(entry => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${entry.name}</td><td>${entry.score}</td>`;
      tbody.appendChild(row);
    });
  }

  async function restartGame() {
    location.reload();
  }

  window.onload = async () => {
    try {
      const res = await fetch(`${backendURL}/leaderboard`);
      const data = await res.json();
      renderLeaderboard(data);
    } catch (err) {
      console.error('‚ùå Failed to load leaderboard:', err);
    }
  };
</script>

</body>
</html>
